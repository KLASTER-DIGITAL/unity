# Query Performance Monitoring Guide

## üìä –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è UNITY-v2.

**–¶–µ–ª—å:** –û–±–Ω–∞—Ä—É–∂–∏–≤–∞—Ç—å –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ë–î –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–∏ –ø–æ–≤–ª–∏—è—é—Ç –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–ß–∞—Å—Ç–æ—Ç–∞:** –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ (–∫–∞–∂–¥—É—é –ø—è—Ç–Ω–∏—Ü—É –≤ 10:00 UTC)

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

### 1. Slow Queries (–ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
- **–ß—Ç–æ:** –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –º–µ–¥–ª–µ–Ω–Ω–µ–µ 1 —Å–µ–∫—É–Ω–¥—ã
- **–ù–æ—Ä–º–∞:** 0-5 –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ö—Ä–∏—Ç–∏—á–Ω–æ:** >10 –∑–∞–ø—Ä–æ—Å–æ–≤
- **–î–µ–π—Å—Ç–≤–∏–µ:** –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã

### 2. Cache Hit Rate (–ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –∫—ç—à)
- **–ß—Ç–æ:** –ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–æ–≤, –æ–±—Å–ª—É–∂–∏–≤–∞–µ–º—ã—Ö –∏–∑ –∫—ç—à–∞
- **–ù–æ—Ä–º–∞:** >95%
- **–û—Ç–ª–∏—á–Ω–æ:** >99%
- **–ö—Ä–∏—Ç–∏—á–Ω–æ:** <90%
- **–î–µ–π—Å—Ç–≤–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –∏ –∏–Ω–¥–µ–∫—Å—ã

### 3. Avg Rows Per Call (–°—Ä–µ–¥–Ω–µ–µ —Å—Ç—Ä–æ–∫ –Ω–∞ –∑–∞–ø—Ä–æ—Å)
- **–ß—Ç–æ:** –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–º
- **–ù–æ—Ä–º–∞:** <10 –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ö—Ä–∏—Ç–∏—á–Ω–æ:** >100 (–≤–æ–∑–º–æ–∂–Ω–∞ N+1 –ø—Ä–æ–±–ª–µ–º–∞)
- **–î–µ–π—Å—Ç–≤–∏–µ:** –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é

---

## üîç –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–∏—Ö –º–µ—Ç—Ä–∏–∫ (2025-10-21)

### ‚úÖ –•–æ—Ä–æ—à–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

**Cache Hit Rate: 99.98%** üéâ
- –û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ
- –ò–Ω–¥–µ–∫—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- PostgreSQL –∫—ç—à–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã

**Avg Rows Per Call: 3.1** ‚úÖ
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ!
- –ó–∞–ø—Ä–æ—Å—ã –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –ª–∏—à–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ
- –ù–µ—Ç N+1 –ø—Ä–æ–±–ª–µ–º

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è

**Slow Queries: 12** ‚ö†Ô∏è
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ 12 –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ù–û:** –í—Å–µ –æ–Ω–∏ - —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã Supabase Studio
- **–í—ã–≤–æ–¥:** –ù–µ –≤–ª–∏—è—é—Ç –Ω–∞ production –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üìã –¢–æ–ø –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 1. `SELECT name FROM pg_timezone_names` (48.5% –≤—Ä–µ–º–µ–Ω–∏)

**–ú–µ—Ç—Ä–∏–∫–∏:**
- Time consumed: 48.5%
- Count: 194 –≤—ã–∑–æ–≤–∞
- Max time: 912ms
- Mean time: 180ms

**–ò—Å—Ç–æ—á–Ω–∏–∫:** Supabase Studio (–∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å)

**–í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** ‚ùå –ù–ï–¢

**–î–µ–π—Å—Ç–≤–∏–µ:** ‚úÖ –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å (—Å–∏—Å—Ç–µ–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å)

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –∏–¥–µ—Ç –æ—Ç Supabase Dashboard
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ API –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å Dashboard –ø–æ—Å–ª–µ —Ä–∞–±–æ—Ç—ã

---

### 2. `WITH -- Recursively get the base types...` (8.9% –≤—Ä–µ–º–µ–Ω–∏)

**–ú–µ—Ç—Ä–∏–∫–∏:**
- Time consumed: 8.9%
- Count: 194 –≤—ã–∑–æ–≤–∞
- Max time: 150ms
- Mean time: 33ms

**–ò—Å—Ç–æ—á–Ω–∏–∫:** Supabase Studio (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ PostgreSQL)

**–í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** ‚ùå –ù–ï–¢

**–î–µ–π—Å—Ç–≤–∏–µ:** ‚úÖ –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å (—Å–∏—Å—Ç–µ–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å)

---

### 3. `with tables as (SELECT c.oid :: int8...)` (6.7% –≤—Ä–µ–º–µ–Ω–∏)

**–ú–µ—Ç—Ä–∏–∫–∏:**
- Time consumed: 6.7%
- Count: 25 –≤—ã–∑–æ–≤–æ–≤
- Max time: 339ms
- Mean time: 195ms

**–ò—Å—Ç–æ—á–Ω–∏–∫:** Supabase Studio (—Å—Ö–µ–º–∞ –ë–î)

**–í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** ‚ùå –ù–ï–¢

**–î–µ–π—Å—Ç–≤–∏–µ:** ‚úÖ –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å (—Å–∏—Å—Ç–µ–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å)

---

## üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### GitHub Action

**–§–∞–π–ª:** `.github/workflows/query-performance-monitor.yml`

**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:**
- –ö–∞–∂–¥—É—é –ø—è—Ç–Ω–∏—Ü—É –≤ 10:00 UTC (13:00 MSK)
- –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ GitHub Actions UI

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç –≤ `docs/reports/`
3. –°–æ–∑–¥–∞–µ—Ç GitHub Issue –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º
4. –ö–æ–º–º–∏—Ç–∏—Ç –æ—Ç—á–µ—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

**–ê–ª–µ—Ä—Ç—ã:**
- –°–æ–∑–¥–∞–µ—Ç—Å—è Issue —Å –º–µ—Ç–∫–æ–π `performance`
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ GitHub
- Exit code 1 –¥–ª—è CI/CD

---

### –°–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–§–∞–π–ª:** `scripts/monitor-query-performance.ts`

**–ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é:**
```bash
npm run monitor:queries
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- Slow Queries (>1s)
- Cache Hit Rate (<95%)
- Avg Rows Per Call (>100)
- Time Consumed (>10% –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º)

**–í—ã–≤–æ–¥:**
- –¶–≤–µ—Ç–Ω–æ–π –æ—Ç—á–µ—Ç –≤ –∫–æ–Ω—Å–æ–ª–∏
- Markdown –æ—Ç—á–µ—Ç –≤ `docs/reports/`
- Exit code 0/1 –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

---

## üìà –ü–æ—Ä–æ–≥–∏ –∏ –∞–ª–µ—Ä—Ç—ã

### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ (üö® Exit code 1)

```typescript
const THRESHOLDS = {
  SLOW_QUERY_TIME: 1000,        // ms
  CACHE_HIT_RATE: 95,           // %
  MAX_ROWS_PER_CALL: 100,       // rows
  CRITICAL_TIME_CONSUMED: 10,   // %
};
```

### –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (‚ö†Ô∏è Warning)

- Slow Queries: 5-10
- Cache Hit Rate: 90-95%
- Avg Rows Per Call: 50-100

### –ù–æ—Ä–º–∞ (‚úÖ OK)

- Slow Queries: 0-5
- Cache Hit Rate: >95%
- Avg Rows Per Call: <50

---

## üõ†Ô∏è –î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∞–ª–µ—Ä—Ç–∞—Ö

### 1. Cache Hit Rate < 95%

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏
- –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã
- –°–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç –ª–∏ `SELECT`)
2. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å JOIN –∑–∞–ø—Ä–æ—Å—ã
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `EXPLAIN ANALYZE`

### 2. Slow Queries > 10

**–ü—Ä–∏—á–∏–Ω—ã:**
- –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã
- N+1 –ø—Ä–æ–±–ª–µ–º—ã
- –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ù–∞–π—Ç–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ (Edge Functions, Frontend)
2. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å batch loading
4. –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### 3. Avg Rows Per Call > 100

**–ü—Ä–∏—á–∏–Ω—ã:**
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
- –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Å—Ä–∞–∑—É
- N+1 –ø—Ä–æ–±–ª–µ–º—ã

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –î–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `limit` –∏ `offset`
3. –ó–∞–≥—Ä—É–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å SELECT (—Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è)

---

## üìä –û—Ç—á–µ—Ç—ã

### –§–æ—Ä–º–∞—Ç –æ—Ç—á–µ—Ç–∞

```markdown
# Query Performance Report - YYYY-MM-DD

## üìä –û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏
- Slow Queries: X
- Cache Hit Rate: X%
- Avg Rows Per Call: X

## üîç –¢–æ–ø-5 –∑–∞–ø—Ä–æ—Å–æ–≤
[–î–µ—Ç–∞–ª–∏ –∑–∞–ø—Ä–æ—Å–æ–≤]

## ‚ö†Ô∏è –ê–ª–µ—Ä—Ç—ã
[–°–ø–∏—Å–æ–∫ –∞–ª–µ—Ä—Ç–æ–≤]

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
[–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏]
```

### –•—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤

**–ü—É—Ç—å:** `docs/reports/query-performance-YYYY-MM-DD.md`

**Retention:** 90 –¥–Ω–µ–π (GitHub Actions artifacts)

**Git:** –ö–æ–º–º–∏—Ç—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –î–æ–±–∞–≤–∏—Ç—å npm —Å–∫—Ä–∏–ø—Ç

```json
{
  "scripts": {
    "monitor:queries": "ts-node scripts/monitor-query-performance.ts"
  }
}
```

### 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å GitHub Secrets

–î–æ–±–∞–≤–∏—Ç—å –≤ Settings ‚Üí Secrets:
- `VITE_SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`

### 3. –í–∫–ª—é—á–∏—Ç—å GitHub Actions

–§–∞–π–ª —É–∂–µ —Å–æ–∑–¥–∞–Ω: `.github/workflows/query-performance-monitor.yml`

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [Performance Optimization Report](./PERFORMANCE_OPTIMIZATION_REPORT.md)
- [Supabase Advisors Guide](../guides/SUPABASE_ADVISORS.md)
- [Database Indexing Strategy](../architecture/DATABASE_INDEXING.md)

---

## üéØ –¶–µ–ª–∏ –Ω–∞ 2025

- ‚úÖ Cache Hit Rate: >99% (–¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ: 99.98%)
- ‚úÖ Avg Rows Per Call: <10 (–¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ: 3.1)
- ‚è≥ Slow Queries: 0 (—Ç–µ–∫—É—â–µ–µ: 12, –Ω–æ –≤—Å–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ)
- ‚è≥ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: –ù–∞—Å—Ç—Ä–æ–µ–Ω
- ‚è≥ –ê–ª–µ—Ä—Ç—ã: –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-10-21  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–∫—Ç–∏–≤–Ω–æ  
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:** AI Agent + DevOps

