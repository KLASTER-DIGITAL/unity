<!-- 94c3d47a-db83-4b11-b243-8d6ed609015d 285b10a5-f912-4c5e-bc21-ca396a3dacae -->
# –ê–Ω–∞–ª–∏–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Cards Module –∏ Books Module

## üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï

### ‚úÖ –ß–¢–û –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

#### 1. Cards Module (—á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ ~60%)

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

- ‚úÖ **AchievementHomeScreen** —Å SwipeCard –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º
  - –°–≤–∞–π–ø-–∫–∞—Ä—Ç–æ—á–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π (right/left swipe)
  - –°—Ç–µ–∫–æ–≤–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (–¥–æ 3 –∫–∞—Ä—Ç–æ—á–µ–∫)
  - –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã –ø–æ sentiment (positive/neutral/negative)
  - –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ (ru/en/es/de/fr/zh/ja)

- ‚úÖ **AI –∞–Ω–∞–ª–∏–∑ –∑–∞–ø–∏—Å–µ–π** 
  - POST `/chat/analyze` - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å OpenAI
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: reply, summary, insight, sentiment, category, tags, mood
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ DiaryEntry —Å –ø–æ–ª—è–º–∏ aiSummary, aiInsight

- ‚úÖ **–•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö**
  - KV Store (`kv_store_9729c493`) –¥–ª—è –∑–∞–ø–∏—Å–µ–π
  - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: `entry:{entryId}` –∏ `user_entries:{userId}`

**–ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

‚ùå **–ù–µ—Ç —Ç–∞–±–ª–∏—Ü—ã entry_summaries**

  - –ü–æ PRD —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
  - –°–µ–π—á–∞—Å summary —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ DiaryEntry, –Ω–æ –Ω–µ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ

‚ùå **–ù–µ—Ç API endpoint `getMotivationCards`**

  - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç GET `/api/motivations/cards/{userId}`
  - –ö–∞—Ä—Ç–æ—á–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∏–∑ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π, –∞ –Ω–µ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 48 —á–∞—Å–æ–≤

‚ùå **–ù–µ—Ç —Å–∏—Å—Ç–µ–º—ã KV –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫**

  - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `card_views:{userId}` —Å TTL 24h
  - –ù–µ—Ç API `markCardAsRead`

‚ùå **–ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏**

  - –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∏–∑ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π, –∞ –Ω–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 48 —á–∞—Å–æ–≤

#### 2. Books Module (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û 0%)

**–ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**

‚ùå **–¢–∞–±–ª–∏—Ü—ã –≤ –ë–î:**

  - `books_archive` - —Ö—Ä–∞–Ω–∏–ª–∏—â–µ PDF –∫–Ω–∏–≥
  - `story_snapshots` - –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º

‚ùå **UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

  - –ú–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–∏–≥–∏ (Step 1-3)
  - Draft Editor —ç–∫—Ä–∞–Ω
  - Books Library —ç–∫—Ä–∞–Ω

‚ùå **Backend —Ñ—É–Ω–∫—Ü–∏–∏:**

  - `compile_snapshot` - –∞–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
  - `generate_draft` - AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –∫–Ω–∏–≥–∏
  - `render_pdf` - —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ PDF

‚ùå **API endpoints:**

  - POST `/api/books/generate-draft`
  - GET `/api/books/{draftId}`
  - POST `/api/books/{draftId}/save`
  - POST `/api/books/{draftId}/render-pdf`
  - GET `/api/books/archive`

## üîß –ß–¢–û –ù–£–ñ–ù–û –î–û–†–ê–ë–û–¢–ê–¢–¨

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ó–∞–≤–µ—Ä—à–∏—Ç—å Cards Module

1. **–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É entry_summaries**
```sql
CREATE TABLE entry_summaries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  entry_id UUID REFERENCES entries(id),
  user_id UUID REFERENCES profiles(id),
  summary_json JSONB NOT NULL,
  tokens_used INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API getMotivationCards**

  - –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º 48 —á–∞—Å–∞–º
  - –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–∑ KV
  - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ

3. **–î–æ–±–∞–≤–∏—Ç—å KV –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤**

  - `card_views:{userId}` —Å TTL 86400 —Å–µ–∫
  - API endpoint `markCardAsRead`

4. **–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å AI –∞–Ω–∞–ª–∏–∑**

  - –ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å summary –≤ entry_summaries
  - –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å tokens_used –¥–ª—è –º–µ—Ç—Ä–∏–∫

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Books Module

1. **–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î**

  - –¢–∞–±–ª–∏—Ü–∞ books_archive
  - –¢–∞–±–ª–∏—Ü–∞ story_snapshots

2. **–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å UI Wizard**

  - SelectPeriodStep
  - SelectContextsStep  
  - ChooseStyleStep

3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å backend**

  - –§—É–Ω–∫—Ü–∏—è compile_snapshot
  - AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏
  - PDF —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ (Puppeteer)

4. **API endpoints**

  - –ü–æ–ª–Ω—ã–π CRUD –¥–ª—è –∫–Ω–∏–≥
  - Supabase Storage –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è PDF (–≤–º–µ—Å—Ç–æ S3)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: Token Optimization

1. **–ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**

  - Monthly snapshots ‚Üí Quarterly ‚Üí Yearly
  - –ò–∑–±–µ–≥–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

2. **–ú–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**

  - –¢–∞–±–ª–∏—Ü–∞ openai_usage —É–∂–µ –µ—Å—Ç—å
  - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Å—á—ë—Ç —Ç–æ–∫–µ–Ω–æ–≤ –≤–æ –≤—Å–µ AI –≤—ã–∑–æ–≤—ã

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:

1. **–ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å KV Store –Ω–∞ Supabase Tables**

  - –°–µ–π—á–∞—Å –∑–∞–ø–∏—Å–∏ –≤ `kv_store_9729c493`, –Ω–æ –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ `entries`
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—É—é –ë–î –¥–ª—è –ª—É—á—à–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

2. **–†–∞–∑–¥–µ–ª–∏—Ç—å Edge Functions**

  - `cards-api.ts` - –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
  - `books-api.ts` - –¥–ª—è –∫–Ω–∏–≥
  - `ai-analysis.ts` - –¥–ª—è OpenAI

3. **–î–æ–±–∞–≤–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏**

  - –¢–∞–±–ª–∏—Ü–∞ entries –≤–∫–ª—é—á–µ–Ω–∞ RLS, –Ω–æ –±–µ–∑ –ø–æ–ª–∏—Ç–∏–∫
  - –ó–∞—â–∏—Ç–∏—Ç—å entry_summaries, books_archive

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:

1. **TypeScript —Ç–∏–ø–∏–∑–∞—Ü–∏—è**

  - –°–æ–∑–¥–∞—Ç—å shared types –¥–ª—è Cards/Books
  - –ò–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤

2. **Error Handling**

  - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ OpenAI
  - Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è AI –∑–∞–ø—Ä–æ—Å–æ–≤

3. **Caching Strategy**

  - React Query –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫—ç—à–∞
  - Invalidation –ø—Ä–∏ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å—è—Ö

### –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

1. **Dashboard –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤**

  - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è openai_usage
  - –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –±—é–¥–∂–µ—Ç–∞

2. **Performance tracking**

  - –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ < 2 —Å–µ–∫
  - –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–Ω–∏–≥–∏ < 45 —Å–µ–∫

## üìà –û–¶–ï–ù–ö–ê –¢–†–£–î–û–ó–ê–¢–†–ê–¢

- **Cards Module –¥–æ—Ä–∞–±–æ—Ç–∫–∞:** 3-4 –¥–Ω—è
  - DB –º–∏–≥—Ä–∞—Ü–∏–∏: 4 —á–∞—Å–∞
  - API endpoints: 8 —á–∞—Å–æ–≤
  - KV –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: 4 —á–∞—Å–∞
  - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: 8 —á–∞—Å–æ–≤

- **Books Module —Å –Ω—É–ª—è:** 10-12 –¥–Ω–µ–π
  - DB —Å—Ö–µ–º–∞: 1 –¥–µ–Ω—å
  - UI Wizard: 3 –¥–Ω—è
  - Backend logic: 4 –¥–Ω—è
  - PDF rendering: 2 –¥–Ω—è
  - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: 2 –¥–Ω—è

- **Token Optimization:** 2-3 –¥–Ω—è
  - Snapshot –∞–≥—Ä–µ–≥–∞—Ü–∏—è: 1 –¥–µ–Ω—å
  - –ú–µ—Ç—Ä–∏–∫–∏: 1 –¥–µ–Ω—å
  - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: 1 –¥–µ–Ω—å

**–ò—Ç–æ–≥–æ:** ~15-19 –¥–Ω–µ–π –Ω–∞ –ø–æ–ª–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é